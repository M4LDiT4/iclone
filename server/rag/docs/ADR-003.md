# ADR-003: Authentication & Tenant Resolution

## Status

Accepted

---

## Context

The RAG server must authenticate users securely and resolve tenant context for multi-tenant data isolation. The system uses **Firebase Auth** as the authentication provider. Each API request must:

* Verify the userâ€™s identity
* Resolve the tenant associated with the user
* Enforce tenant isolation for vector retrieval and RAG operations

This is crucial because relying on client-provided IDs or tokens alone is insecure.

---

## Decision

1. **Authentication**

   * All clients authenticate via Firebase Auth SDK (Web, iOS, Android).
   * Firebase issues **ID tokens (JWTs)** upon login.
   * Clients include the JWT in the `Authorization: Bearer <idToken>` header for every API request.

2. **Server-Side JWT Verification**

   * FastAPI server verifies the Firebase JWT on every request using Firebase Admin SDK.
   * Verification ensures:

     * Signature is valid
     * Token has not expired
     * Issuer and audience match the Firebase project
   * Extracts the `uid` from the token for user identification.

3. **Tenant Resolution**

   * Backend maintains a mapping of `uid` to tenant ID and roles (in Postgres, Firestore, or similar).
   * Server resolves tenant from the verified `uid`.
   * Tenant ID is **never accepted from client**.

4. **Multi-Tenancy Enforcement**

   * Every Pinecone query includes a filter on `tenantId`.
   * All RAG operations are scoped to the resolved tenant.
   * Any request without proper tenant resolution is rejected with `403 Forbidden`.

5. **Token Lifecycle**

   * Firebase ID tokens are valid for ~1 hour.
   * Clients refresh tokens automatically via Firebase SDK using the refresh token.
   * Server always verifies JWT per request; no manual rotation is needed.
   * Concurrent API requests handle token refresh via client-side logic (e.g., Axios interceptor with queue).

---

## Rationale

* **Security:** Server does not trust client-provided UID; JWT verification ensures identity.
* **Scalability:** Stateless authentication allows horizontal scaling of FastAPI servers.
* **Compatibility:** Works seamlessly with multi-tenant design (ADR-002).
* **Maintainability:** Clear separation between authentication, authorization, and RAG logic.

---

## Consequences

### Positive

* Strong security guarantees with minimal server overhead
* Stateless API design simplifies deployment and scaling
* Clean integration with multi-tenant RAG architecture

### Negative / Trade-offs

* Backend requires Firebase Admin SDK and network access to verify tokens
* Token expiration requires client-side handling of refresh and retry logic
* Misconfiguration of tenant mapping could lead to access issues

---

## Alternatives Considered

### Use Firebase Auth UID directly without JWT verification

* Rejected due to spoofing risk and lack of security guarantees

### Use a custom authentication system

* Rejected to avoid reinventing secure JWT auth and managing password/OAuth flows

### Accept tenant ID from client

* Rejected because it breaks multi-tenancy isolation

---

## Related Documents

* ADR-001: Backend Stack Selection
* ADR-002: Multi-Tenancy Strategy
* RAG Server Architecture Document

---

## Notes

* Client SDKs (Web, iOS, Android) should handle automatic token refresh.
* Axios (or similar) interceptors recommended for adding JWT to API requests.
* Server-side code should always verify JWT and resolve tenant for every request.
