# ADR-002: Multi-Tenancy Strategy for RAG Knowledge Base

## Status

Accepted

---

## Context

The RAG server must support multiple independent users or organizations (tenants) sharing the same infrastructure. Each tenant's documents must remain isolated to prevent data leakage, while still allowing efficient retrieval and generation.

Requirements:

* Strong tenant data isolation
* Secure retrieval and generation
* Minimal operational overhead
* Compatibility with Pinecone vector database

---

## Decision

We will implement **metadata-based multi-tenancy**:

* Every document chunk stored in Pinecone will include a `tenantId` metadata field.
* Every query to the vector database will include a mandatory filter on `tenantId`.
* Tenant context is always resolved **server-side** using the authenticated user's UID from Firebase Auth.

This ensures that tenants cannot access each other's data even if they attempt to manipulate queries.

---

## Rationale

### Metadata-Based Isolation

* Supports all tenants in a single Pinecone index.
* Scales efficiently with growing number of tenants.
* Supported natively by Pinecone filtering.
* Simplifies deployment and operational overhead compared to separate databases per tenant.

### Server-Side Enforcement

* Tenant resolution is done using Firebase UID and a backend database mapping users to tenants.
* The client never specifies the `tenantId`.
* Queries without proper tenant metadata are rejected.

This aligns with the security principle of **trusting the server, not the client**.

---

## Consequences

### Positive

* Strong logical isolation between tenants
* Lower operational cost
* Scalable deployment
* Simple alignment with RAG architecture and future extensions

### Negative / Trade-offs

* Relies on strict enforcement of tenant filters in code
* Logical isolation is weaker than physical database separation
* Misconfiguration could lead to accidental data exposure

These trade-offs are acceptable for the expected scale and complexity of the system.

---

## Alternatives Considered

### Separate Index per Tenant

* Pros: Stronger isolation
* Cons: Higher operational overhead, harder to scale

### Database per Tenant

* Pros: Strongest isolation
* Cons: High cost and complexity

### Client-Specified Tenant Filtering

* Rejected because it allows clients to manipulate tenant context

---

## Related Documents

* ADR-001: Backend Stack Selection
* ADR-003: Authentication & Tenant Resolution (planned)
* RAG Server Architecture Document

---

## Notes

* Multi-tenancy enforcement must be audited and tested thoroughly.
* This decision provides the foundation for future enhancements such as role-based access control and hybrid search strategies.
